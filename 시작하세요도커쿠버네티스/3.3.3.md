# 3.3.3 스웜모드 서비스

## 스웜 모드 서비스 개념

- 지금까진 컨테이너 하나를 대상으로 하는 명령어
    - `docker run ~`
- 스웜모드에서 제어하는 단위는 컨테이너 하나가 아닌 **서비스(Service)**
- 서비스란 **같은 이미지에서 생성된 컨테이너의 집합**
    - 서비스를 제어하면 해당서비스 내의 컨테이너에 같은 명령이 수행된다.
    - 서비스엔 1개이상의 컨테이너가 존재할수있으며, 컨테이너들은 각 ‘워커 노드'와 ‘매니저 노드'에 할당됨 (이런 워커노드와 매니저노드에게 할당된 컨테이너들을 Task라고한다.)

- ‘ubuntu:14.04’ 이미지로 서비스를 생성하고 컨테이너 세개로 설정한 상황
    - 스웜 스케쥴러는 서비스 정의에 따라 컨테이너를 할당할 적합하 노드선정후 분산하여 할당

```docker
“매니저노드”(ubuntu:14.04 컨테이너 할당됨) - “워커 노드”(ubuntu:14.04 컨테이너 할당됨)
                                    - “워커 노드”(ubuntu:14.04 컨테이너 할당됨)
```

- 노드에 할당된 컨테이너들을 “레플리카"라고 한다. → 서비스에 설정된 레플리카의 수만큼의 컨테이너가 스웜 클러스터내에 존재(서비스에서 세개의 컨테이너로 설정하였기에 스웜클러스터내에 총 세개의 레플리카가 있다.)

- 스웜은 서비스의 컨테이너들을 계속 보며 서비스내의 레플리카의 수만큼 컨테이너가 스웜클러스터에 존재하지않으면 다른 노드에 레플리카 생성
    
    ```docker
    <워커노드 하나 고장>
    “매니저노드”(ubuntu:14.04 컨테이너 할당됨) - “워커 노드” X 고장!! 삐뽀삐뽀(ubuntu:14.04 컨테이너 할당됨)
                                        - “워커 노드”(ubuntu:14.04 컨테이너 할당됨)
    
    -> 스웜은 2개의 레플리카를 보고 다른 노드에 해당 컨테이너를 생성
    “매니저노드”(ubuntu:14.04 컨테이너 할당됨) - “워커 노드” X 고장!! 삐뽀삐뽀(ubuntu:14.04 컨테이너 할당됨)
                                        - “워커 노드”(ubuntu:14.04 컨테이너 할당됨1, ubuntu:14.04 컨테이너 할당됨2)
    ```
    

> 서비스는 롤링 업데이트를 한다. 서비스내 여러개의 컨테이너들의 이미지가 업데이트되야할때 하나의 컨테이너씩 순서대로 업데이트하는 것을 롤링업데이트(한꺼번에 서비스의 모든 컨테이너가 업데이트 되면 Down Time(다운 시간)이 생긴다.
> 

## 서비스 생성

- 서비스 제어하는 도커 명령어는 전부 **매니저 노드**에서 만 사용할 수 있다.

```docker
docker service create \
ubuntu:14.04 \
/bin/sh -c "while true; do echo hello world; sleep 1; done"
(매니저노드에서 실행)
```

(ubuntu:14.04 이미지로 서비스 내의 컨테이너를 생성하며 컨테이너 실행될 때 “hello world”출력)

- 스웜 클러스태의 서비스 목록 조회
    - `docker service ls`
- 스웜 클러스터 내의 서비스 자세한 정보 확인
    - `docker service ps ${service 이름}`
- 서비스 삭제
    - `docker service rm ${service 이름}`
- replicas 옵션으로 생성할 서비스의 컨테이너 수를 지정할수있다
    - `docker service create --name myWeb --replicas 2 -p 80:80 nginx` : nginx이미지의 2개의 컨테이너를 가진 서비스를 myWeb의 이름의 서비스로 생성
    - `docker service ps myWeb`
        - nginx swarm-manager Running ~
        - nginx swarm-worker1 Running ~
            - 매니저노드와 워커1노드에 nginx 컨테이너가 각각 실행중.
    - -p 옵션은 스웜클러스터 자체에 80번 포트를 개방한것 (클러스터의 어떠한 노드로 접근해도 nginx웹서버에 접근가능)
        - swarm-worker2의 ip:80 으로도 nginx에 접근가능
- scale이라는 명령어로 컨테이너 수 늘릴수도있다.
    - `docker service scale myWeb=4`
    - 3개의 노드중 하나는 컨테이너 두개실행중. → 이는 문제 X
        - 이 컨테이너들은 각 컨테이너가 실행중인 호스트(워커노드나 매니저노드)의 80번 포트에 연결된 것이 아니고, 각 노드의 80번포트로 들어온 요청을 컨테이너중 한개로 리다이렉트 한다.(로드 밸런싱과 같은?)
            - 스웜모드에선 **라운드 로빈**방식으로 서비스내에 접근할 컨테이너를 결정한다고 한다.
- global 서비스 생성
    - replica로 생성할 컨테이너의 개수를 지정하는게 아닌 global로 서비스를 생성할수있다. 그러면 **노드당 하나의 컨테이너가**생성 되기 때문에 레플리카 수를 따로 지정하지 않는다.

> 이런 명령어는 모두 매니저노드에서 실행한 것들이다.
> 

## 스웜모드의 서비스 장애 복구

- 레플리카로 설정한 서비스의 컨테이너 하나 정지  or 특정 노드(워커 노드 or 매니저 노드)가 다운되면 스웜매니저는 새로운 컨테이너 생성해 자동으로 복구
    - “컨테이너 하나 정지하던, 컨테이너가 실행되던 호스트인 하나의 노드가 중지되던 스웜 매니저가 새로운 컨테이너 생성해 자동으로 복구”
- 그러나 노드가 중지되면, 해당 노드에 실행중이던 서비스의 컨테이너가 다른 노드에 컨테이너가 생성되는데(스웜 매니저에 의해) 다시 노드가 복구된다고 해서 원래의 노드로 컨테이너가 재할당되진 않는다.
    
    → `scale` 명령어로 다시 할당의 균형을 수동으로 맞춰야함
    

## 서비스 롤링 업데이트

- 스웜모드에선 롤링 업데이트 자체적으로 지원
- 서비스를 생성할 때, `--update-delay`, `--update-parallelism` 으로 롤링업데이트 정보를 넣을 수 있다.

## 도커스웜 네트워크

- 스웜모드에선 여러개의 도커엔진에 “같은 컨테이너들을 분산해서 할당"하기 때문에 각 도커데몬의 네트워크가 하나로 묶인, **네트워크 풀**이 필요하다.
    - 서비스를 외부에 노출했을 대 어떤 노드로 접근하더라도 해당 서비스의 컨테이너에 접근하기 위한 **라우팅 기능**이 필요
- `docker-gwbridge` : 오버레이 네트워크
- `ingress`: 로드밸런싱과 라우팅 메시에 사용

## ingress 네트워크

- 스웜 클러스터 생성하면 자동으로 등록되는 네트워크
    - 스웜 클러스터내의 매니저 노드 뿐만 아니라 워커 노드 모두 `ingress`  네트워크가 생성되어있다.
        
        ![스크린샷 2022-06-08 23.14.19.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/dd8faf4a-b231-48d3-ba25-ac15891c5ead/스크린샷_2022-06-08_23.14.19.png)
        

- `192.168.99.102:8080` 으로 요청해도, ingress network덕분에 node1의 container, node2의 컨테이너에 접근할수있다.

## 오버레이 네트워크

- 여러개의 도커 데몬을 하나의 네트워크 풀로 만드는 네트워크 가상화 기술중 하나.
    - 오버레이 네트워크덕에 여러 도커 데몬(서버)에 존재하는 컨테이너가 서로 통신할수 있다.
        
        ![스크린샷 2022-06-08 23.17.34.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9029ccec-5e55-4976-b6bd-dce513a22d64/스크린샷_2022-06-08_23.17.34.png)
        
    - docker-node1의 컨테인어는 별도의 포트포워딩을 하지않아도 docker-node2의 컨테이너에 ping전송가능

## 서비스 디스커버리

- 한 서비스의 여러개의 같은 컨테이너를 사용할 때, 한 컨테이너가 새러 생성되었는지(발견), 없어졌는지 어떻게 감지할까?
    - → 서비스 발견기능이라한다.
- 2개의 컨테인어 레플리카 B서비스, A서비스는 B서비스의 컨테이너를 사용
    - 상황: B서비스의 컨테이너 scale명령어로 3개로 증가. A는 B의 새로운 컨테이너 접근가능?
    - 스웜모드에선 B라는 이름으로 A는 B의 모든 컨테이너에 접근할수있다.

## 스웜 모드 볼륨

- 컨테이너 실행할때, 호스트와 디렉토리 공유하려면 `-v` 옵션으로 컨테이너 실행했었다. 스웜모드에선?
- 스웜모드에서 도커 볼륨을 사용하는 서비스를 생성하려면 서비스 생성할 때 `--mount` 옵션을 붙이면 된다.

## 스웜모드 볼륨 한계

- 스웜 클러스터에서 볼륨사용하기 힘듬
    - 왜? 서비스를 할당받을수 있는 모든 노드가 볼륨데이터를 가지고있어야함. 모두 가지고있어야하며 심지어 볼륨 끼리 sync도 맞아야 할것이다. → 좋지 못함
    - **퍼시스턴트 스토리지**를 사용하면된다.
        - 퍼시스턴트 스토리지란 호스트와 컨테이너와 별개로 외부에 존재하는 네트워크로 마운트 할수 있는 스토리지이다.
    
    ```docker
    
    swarm manager -> node 1 (container ing~)
    
    																								- persistence storage
    							-> node 2 (container ing~)
    ```
    
    →  그러나 퍼시스턴스 스토리지는 도커 자체에서 제공하지않아 서드파티 플러그인을 이용해야한다.